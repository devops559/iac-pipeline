name: IAC Beta

on:
  workflow_dispatch:

jobs:
  check-promotion:

    name: Verify DEV promotion
    runs-on: ubuntu-latest
    steps:
      - name: Check DEV promotion release
        uses: actions/github-script@v7
        with:
          script: |
            const tag = `dev-${context.sha}`;
            try {
              await github.rest.repos.getReleaseByTag({
                owner: context.repo.owner,
                repo: context.repo.repo,
                tag
              });
              console.log(`DEV promotion found: ${tag}`);
            } catch (e) {
              core.setFailed(`DEV not promoted for commit ${context.sha}`);
            }
  beta:
    needs: check-promotion
    uses: ./.github/workflows/infra-pipeline.yml
    with:
      env: beta
      iac_tool: terraform
    secrets: inherit
